---
title: "4_6MEETING"
author: "Tian Qin"
date: '2022-04-06'
output: html_document
---



Original C.I

$$
(-\infty, \hat{\theta}+z_{\alpha}\frac{\hat{\sigma}}{\sqrt{n}})
$$

Adjusted C.I


$$
(-\infty, \hat{\theta}+(z_{\alpha}+t)\frac{\hat{\sigma}}{\sqrt{n}})
$$


```{r,cache=TRUE}

set.seed(42)
n_simulation <- 5000

n<-10

lambda <- 2

itet <- 30
z <- qnorm(0.99)
ite_l <- matrix(0,nrow=n_simulation,ncol=itet+1)

cover1=cover2=cover3=cover4=NULL
for(t in 1:n_simulation){
  
  gamma_sample <- rgamma(n=n,rate=lambda,shape=1)
  
  MLE <- 1/mean(gamma_sample)
  #MLE <- MLE*(n-1)/n #bias-reduced MLE
  UPB <- MLE+z*MLE/sqrt(n)
  cover1=c(cover1,( lambda<=UPB))
  ite_l[t,1] <- MLE

  est_P <- c()


  t1<-c()
  t1[1] <- 0
for(i in 1:itet){

  boot_sp <-  replicate(50,(1/mean(rgamma(n=n,rate=MLE,shape = 1))))
  upper_bounds <- boot_sp+(z+t1[i])*boot_sp/sqrt(n) 
  est_P[i] <- length(upper_bounds[upper_bounds>=MLE])/length(upper_bounds)
  # theta_star <- quantile(upper_bounds,0.05)
  # t[i] <- theta_star-MLE

    t1[i+1] <- t1[i] +2/i *(0.99-est_P[i])



}

  UPB_corrected <- MLE+(z+t1[itet+1])*MLE/sqrt(n) #UPB+t1[itet+1]
  cover2=c(cover2,(lambda<=UPB_corrected))
#   
  
   #boot3<- replicate(100,(1/mean(rgamma(n=n,rate=MLE,shape = 1))))
     transformed_UPB <- exp(log(MLE)+z/sqrt(n))
   #c_hat <-  (as.numeric(quantile(boot3,0.99))-MLE)*sqrt(n)/(MLE)-z
     cover3=c(cover3,(lambda<transformed_UPB))#c(cover3,(lambda<=MLE+(z+c_hat)*MLE/sqrt(n)))
     
  ##exact
     exact_ub <- qchisq(0.99,df=2*n)/(2*sum(gamma_sample))
     cover4=c(cover4,(lambda<exact_ub))#
}

p1=mean(cover1)
p2=mean(cover2)
p3=mean(cover3)
p4=mean(cover4)
me1=qnorm(0.995)*sqrt(p1*(1-p1)/n_simulation);me1=round(me1,3)
me2=qnorm(0.995)*sqrt(p2*(1-p2)/n_simulation);me2=round(me2,3)
me3=qnorm(0.995)*sqrt(p3*(1-p3)/n_simulation);me3=round(me3,3)
me4=qnorm(0.995)*sqrt(p4*(1-p4)/n_simulation);me4=round(me4,3)
cat("Coverage of ordinary CI=",p1,"plus or minus",me1,"\n")
cat("Coverage of iE adjusted CI=",p2,"plus or minus",me2,"\n")
cat("Coverage of variance-stabilized CI=",p3,"plus or minus",me3,"\n")
cat("Coverage of exact CI=",p4,"plus or minus",me4,"\n")
```

